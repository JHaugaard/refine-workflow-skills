<?xml version="1.0" encoding="UTF-8"?>
<vps-ready-state version="2.0">
  <!--
    VPS State Reference Document
    Generated by: vps-ready Claude Code Skill
    Purpose: Inform AI assistants of exact VPS configuration to avoid redundant checks during deployment

    FILL IN BEFORE USE:
    - Replace {{VPS_ALIAS}} with server alias (e.g., vps1, vps2)
    - Replace {{VPS_IP}} with server IP address
    - Replace {{DOMAIN}} with primary domain (e.g., example.com)
  -->

  <identity>
    <alias>{{VPS_ALIAS}}</alias>
    <ip>{{VPS_IP}}</ip>
    <domain>{{DOMAIN}}</domain>
    <user>john</user>
    <os>Ubuntu/Debian</os>
    <timezone>America/New_York</timezone>
  </identity>

  <ssh>
    <authentication>key-only</authentication>
    <password-auth>disabled</password-auth>
    <root-login>disabled</root-login>
    <port>22</port>
  </ssh>

  <firewall provider="ufw">
    <status>active</status>
    <default-incoming>deny</default-incoming>
    <default-outgoing>allow</default-outgoing>
    <rules>
      <rule port="22" protocol="tcp" action="limit" note="SSH with rate limiting - 6 conn/30s"/>
      <rule port="80" protocol="tcp" action="allow" note="HTTP"/>
      <rule port="443" protocol="tcp" action="allow" note="HTTPS"/>
    </rules>
  </firewall>

  <networking>
    <ipv6>disabled</ipv6>
    <sysctl>
      <setting key="net.ipv6.conf.all.disable_ipv6">1</setting>
      <setting key="net.ipv6.conf.default.disable_ipv6">1</setting>
    </sysctl>
  </networking>

  <docker>
    <installed>true</installed>
    <user-in-group>john</user-in-group>
    <socket>/var/run/docker.sock</socket>
    <tcp-exposed>false</tcp-exposed>
    <daemon-config path="/etc/docker/daemon.json">
      <log-driver>json-file</log-driver>
      <log-max-size>10m</log-max-size>
      <log-max-file>3</log-max-file>
      <live-restore>true</live-restore>
      <userland-proxy>false</userland-proxy>
      <no-new-privileges>true</no-new-privileges>
      <icc>false</icc>
      <ulimit-nofile>64000</ulimit-nofile>
    </daemon-config>
    <network name="jhh-net">
      <driver>bridge</driver>
      <subnet>172.18.0.0/16</subnet>
      <purpose>All app containers and Caddy communicate here</purpose>
    </network>
  </docker>

  <swap>
    <file>/swapfile</file>
    <size>2G</size>
    <swappiness>10</swappiness>
    <persistent>true</persistent>
  </swap>

  <directory-structure root="/home/john/vps-setup">
    <file name=".env.master" permissions="600" purpose="Shared environment variables"/>
    <dir name="caddy">
      <file name="Caddyfile"/>
      <file name="docker-compose.yml"/>
    </dir>
    <dir name="apps" purpose="Application deployments go here"/>
    <dir name="scripts">
      <file name="disk-monitor.sh" executable="true"/>
      <file name="container-health.sh" executable="true"/>
    </dir>
    <dir name="logs/monitoring">
      <file name="disk-alerts.log"/>
      <file name="container-health.log"/>
    </dir>
  </directory-structure>

  <caddy>
    <container-name>caddy</container-name>
    <image>caddy:2.7-alpine</image>
    <status>running</status>
    <restart-policy>unless-stopped</restart-policy>
    <ports>
      <port host="80" container="80" binding="0.0.0.0"/>
      <port host="443" container="443" binding="0.0.0.0"/>
    </ports>
    <volumes>
      <volume host="./Caddyfile" container="/etc/caddy/Caddyfile" mode="ro"/>
      <volume name="caddy_data" container="/data"/>
      <volume name="caddy_config" container="/config"/>
    </volumes>
    <network>jhh-net</network>
    <resources>
      <memory-limit>512m</memory-limit>
      <memory-reservation>256m</memory-reservation>
      <cpu-limit>0.5</cpu-limit>
    </resources>
    <health-check interval="30s" timeout="10s" retries="3"/>
    <config>
      <admin-api>disabled</admin-api>
      <acme-email>jhaugaard@mac.com</acme-email>
      <rate-limit>100 requests/minute per IP</rate-limit>
      <security-headers>
        <header name="Strict-Transport-Security">max-age=31536000; includeSubDomains; preload</header>
        <header name="X-Content-Type-Options">nosniff</header>
        <header name="X-Frame-Options">DENY</header>
        <header name="Referrer-Policy">strict-origin-when-cross-origin</header>
        <header name="X-XSS-Protection">1; mode=block</header>
        <header name="Server" action="remove"/>
      </security-headers>
    </config>
    <snippets available="true">
      <snippet name="security" purpose="Security headers"/>
      <snippet name="ratelimit" purpose="Rate limiting"/>
    </snippets>
  </caddy>

  <env-master path="/home/john/vps-setup/.env.master">
    <var name="VPS_ALIAS">{{VPS_ALIAS}}</var>
    <var name="VPS_IP">{{VPS_IP}}</var>
    <var name="DOMAIN">{{DOMAIN}}</var>
    <var name="DOCKER_NETWORK">jhh-net</var>
    <var name="TZ">America/New_York</var>
    <var name="USER">john</var>
    <var name="DEFAULT_MEM_LIMIT">512m</var>
    <var name="DEFAULT_MEM_RESERVATION">256m</var>
    <var name="DEFAULT_CPU_LIMIT">1.0</var>
    <var name="ADMIN_EMAIL">jhaugaard@mac.com</var>
    <var name="DISK_ALERT_THRESHOLD">80</var>
  </env-master>

  <monitoring>
    <disk-monitor>
      <script>/home/john/vps-setup/scripts/disk-monitor.sh</script>
      <threshold>80%</threshold>
      <schedule>daily at 2 AM</schedule>
      <cron>0 2 * * *</cron>
      <log>/home/john/vps-setup/logs/monitoring/disk-alerts.log</log>
    </disk-monitor>
    <container-health>
      <script>/home/john/vps-setup/scripts/container-health.sh</script>
      <schedule>every 6 hours</schedule>
      <cron>0 */6 * * *</cron>
      <log>/home/john/vps-setup/logs/monitoring/container-health.log</log>
    </container-health>
  </monitoring>

  <auto-updates>
    <package>unattended-upgrades</package>
    <security-updates>enabled</security-updates>
    <config-file>/etc/apt/apt.conf.d/20auto-upgrades</config-file>
  </auto-updates>

  <deployment-pattern>
    <app-location>/home/john/vps-setup/apps/{{APP_NAME}}/</app-location>
    <required-files>
      <file>docker-compose.yml</file>
      <file>.env</file>
    </required-files>
    <container-binding>127.0.0.1:{{PORT}}:{{PORT}}</container-binding>
    <network>jhh-net</network>
    <caddyfile-entry>
      <template><![CDATA[
{{SUBDOMAIN}}.{{DOMAIN}} {
    import security
    import ratelimit
    reverse_proxy {{CONTAINER_NAME}}:{{PORT}}
}
      ]]></template>
    </caddyfile-entry>
    <reload-caddy>docker exec caddy caddy reload --config /etc/caddy/Caddyfile</reload-caddy>
  </deployment-pattern>

  <do-not-repeat reason="Already configured by vps-ready skill">
    <item>System package updates</item>
    <item>UFW firewall installation or configuration</item>
    <item>IPv6 disabling</item>
    <item>Docker installation</item>
    <item>Docker daemon security configuration</item>
    <item>Docker group membership for john</item>
    <item>Swap file creation</item>
    <item>Directory structure creation</item>
    <item>Docker network jhh-net creation</item>
    <item>Caddy deployment</item>
    <item>Monitoring script creation</item>
    <item>Cron job configuration</item>
    <item>Unattended-upgrades installation</item>
  </do-not-repeat>

</vps-ready-state>
